name: Orchestrator Build Trigger

on:
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  issues: write

jobs:
  start_build:
    runs-on: ubuntu-latest
    steps:
      # Always runs so you can see what GitHub actually received
      - name: Debug comment body
        env:
          BODY: ${{ github.event.comment.body }}
        run: |
          echo "=== RAW COMMENT BODY START ==="
          printf "%s\n" "$BODY"
          echo "=== RAW COMMENT BODY END ==="

      # Decide whether to proceed
      - name: Check for /start-build
        id: check
        env:
          BODY: ${{ github.event.comment.body }}
        run: |
          if echo "$BODY" | grep -qi '/start-build'; then
            echo "match=true" >> "$GITHUB_OUTPUT"
            echo "Found /start-build"
          else
            echo "match=false" >> "$GITHUB_OUTPUT"
            echo "Did NOT find /start-build"
          fi

      # Extract run_id from the issue body
      - name: Get issue & extract run_id
        if: steps.check.outputs.match == 'true'
        id: grab
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "== ISSUE BODY =="
          printf "%s\n" "$ISSUE_BODY"
          RUN_ID=$(echo "$ISSUE_BODY" | sed -n 's/.*Run ID:\s*\([0-9a-f-]\{36\}\).*/\1/p' | head -n1)
          if [ -z "$RUN_ID" ]; then
            echo "Could not find Run ID in issue body"; exit 1
          fi
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

      # Try to pull the plan artifact; if absent, we still proceed
      - name: Download plan artifact (best-effort)
        if: steps.check.outputs.match == 'true'
        uses: actions/download-artifact@v4
        with:
          name: orchestrator-plan-${{ steps.grab.outputs.run_id }}
          path: .
        continue-on-error: true

      # Build a Lovable brief (from artifact if present, else placeholders)
      - name: Build Lovable brief markdown
        if: steps.check.outputs.match == 'true'
        run: |
          if [ -f orchestrator.json ]; then
            OBJECTIVE=$(jq -r '.objective' orchestrator.json)
            TASKS=$(jq -r '.tasks[] | "* **\(.title)**\n  " + ( .steps | map("- " + .) | join("\n  ")) + "\n"' orchestrator.json)
            ACCEPT=$(jq -r '.acceptance // [] | map("- " + .) | join("\n")' orchestrator.json)
          else
            OBJECTIVE="(Objective not found in artifact)"
            TASKS="(Tasks artifact missing; see issue text)"
            ACCEPT="(Acceptance unknown)"
          fi

          cat > lovable_brief.md <<'BRIEF'
### Lovable Build Brief

**Context / Objective**
{{OBJECTIVE}}

**What to build**
{{TASKS}}

**Acceptance checks**
{{ACCEPT}}

**Notes**
- Follow repository code style & TypeScript strictness
- Log every step and surface errors
- Keep changes small and incremental; commit early
BRIEF

          sed -i "s|{{OBJECTIVE}}|${OBJECTIVE//|/\\|}|" lovable_brief.md
          sed -i "s|{{TASKS}}|${TASKS//|/\\|}|" lovable_brief.md
          sed -i "s|{{ACCEPT}}|${ACCEPT//|/\\|}|" lovable_brief.md

      # Post the brief on the issue
      - name: Comment Lovable brief on the issue
        if: steps.check.outputs.match == 'true'
        uses: actions/github-script@v7
        env:
          RUN_ID: ${{ steps.grab.outputs.run_id }}
        with:
          script: |
            const fs = require('fs');
            const brief = fs.readFileSync('lovable_brief.md','utf8');
            const body = `âœ… **Build started (manual via Lovable)**
**Run ID:** ${process.env.RUN_ID}

${brief}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      # Flip status to in_build in Supabase
      - name: Mark run as in_build (Supabase)
        if: steps.check.outputs.match == 'true'
        env:
          ORCH_MARK_URL: ${{ secrets.ORCH_MARK_URL }}
          ORCH_ADMIN_SECRET: ${{ secrets.ORCH_ADMIN_SECRET }}
          RUN_ID: ${{ steps.grab.outputs.run_id }}
        run: |
          PAYLOAD=$(jq -n --arg run_id "$RUN_ID" --arg status "in_build" '{run_id:$run_id,status:$status}')
          curl -sS -X POST "$ORCH_MARK_URL" \
            -H "content-type: application/json" \
            -H "x-orch-admin: $ORCH_ADMIN_SECRET" \
            -d "$PAYLOAD"
