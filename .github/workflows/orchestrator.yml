name: Orchestrator: Plan Intake
on:
  repository_dispatch:
    types: [orchestrator_plan_ready]

permissions:
  issues: write
  contents: read

jobs:
  intake:
    runs-on: ubuntu-latest
    steps:
      - name: Show event payload
        run: |
          echo "$GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

      - name: Create orchestrator issue with Lovable brief
        uses: actions/github-script@v7
        with:
          script: |
            const evt = require(process.env.GITHUB_EVENT_PATH);
            const runId =
              evt.client_payload?.orchestrator?.run_id ??
              evt.client_payload?.run_id ??
              null;
            const objective =
              evt.client_payload?.orchestrator?.objective ??
              evt.client_payload?.objective ??
              '';

            if (!runId) {
              core.setFailed('No run_id in repository_dispatch payload');
              return;
            }

            const brief = [
              '## Lovable Build Brief',
              '',
              '**Goal**',
              'Implement automated WETH wrapping on Base (Task 5.1).',
              '',
              '**Why**',
              'Ensure users automatically get WETH when autoWrap=true.',
              '',
              '**Steps**',
              "- Modify `supabase/functions/wallet-ensure-weth/index.ts` to call WETH `deposit()` when `autoWrap=true`.",
              "- Use `_shared/signer.ts` and `_shared/eth.ts` (send raw tx, wait for receipt).",
              "- Preserve plan-only behavior for `autoWrap=false`.",
              "- Return `{ ok:true, action:'wrapped', txHash, gasUsed, balance }` after wrap.",
              "- Return 500 when ETH is insufficient.",
              '',
              '**Acceptance (must be testable)**',
              '- autoWrap=false → ok:true, action is none|wrap.',
              '- autoWrap=true → wraps and returns txHash, gasUsed, and balance ≥ minWethNeeded.',
              '- 500 on insufficient ETH.',
              '- Wrap < 10s; gas ≈ 27k.',
              '',
              '_Generated by Orchestrator_'
            ].join('\n');

            const body = [
              `**Run ID:** ${runId}`,
              `**Objective:** ${objective}`,
              '',
              brief
            ].join('\n');

            const res = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Orchestrator: Plan for ${runId}`,
              body
            });

            core.info(`Created issue #${res.data.number}`);
