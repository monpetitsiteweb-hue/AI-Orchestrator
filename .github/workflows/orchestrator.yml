name: Orchestrator: Plan Intake

on:
  repository_dispatch:
    types: [orchestrator_plan_ready]

permissions:
  issues: write
  contents: read

jobs:
  intake:
    runs-on: ubuntu-latest
    steps:
      - name: Show event payload
        run: |
          echo "$GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

      - name: Extract run_id and objective
        id: evt
        run: |
          set -e
          RUN_ID=$(jq -r '.client_payload.orchestrator.run_id // .client_payload.run_id' "$GITHUB_EVENT_PATH")
          OBJ=$(jq -r '.client_payload.orchestrator.objective // ""' "$GITHUB_EVENT_PATH")
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "No run_id in repository_dispatch payload"; exit 1
          fi
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          printf "objective<<EOF\n%s\nEOF\n" "$OBJ" >> $GITHUB_OUTPUT

      - name: Build Lovable brief (markdown)
        run: |
          cat > lovable_brief.md <<'MD'
          ## Lovable Build Brief

          **Goal**
          Implement automated WETH wrapping on Base (Task 5.1).

          **Why**
          Ensure users automatically get WETH when `autoWrap=true`.

          **Steps**
          - Modify `supabase/functions/wallet-ensure-weth/index.ts` to call WETH `deposit()` when `autoWrap=true`.
          - Use `_shared/signer.ts` and `_shared/eth.ts` (send raw tx, wait for receipt).
          - Preserve plan-only behavior for `autoWrap=false`.
          - Return `{ ok:true, action:'wrapped', txHash, gasUsed, balance }` after wrap.
          - Return 500 with details when ETH is insufficient.

          **Acceptance (must be testable)**
          - `POST /wallet-ensure-weth` with `autoWrap=false` → `ok:true`, `action` is `none|wrap`.
          - `POST /wallet-ensure-weth` with `autoWrap=true` → wraps and returns `txHash`, `gasUsed`, and `balance >= minWethNeeded`.
          - 500 on insufficient ETH.
          - Wrap completes in < 10s; gas ≈ 27k.
          MD

      - name: Create orchestrator issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runId = '${{ steps.evt.outputs.run_id }}';
            const objective = `${{ steps.evt.outputs.objective }}`;
            const body = [
              `**Run ID:** ${runId}`,
              `**Objective:** ${objective}`,
              '',
              fs.readFileSync('lovable_brief.md','utf8'),
              '',
              '_Generated by Orchestrator_'
            ].join('\n');

            const res = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Orchestrator: Plan for ${runId}`,
              body
            });

            core.info(`Created issue #${res.data.number}`);
