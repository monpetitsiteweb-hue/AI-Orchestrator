name: Orchestrator: Plan Intake

on:
  repository_dispatch:
    types: [orchestrator_plan_ready]

permissions:
  issues: write
  contents: read

jobs:
  intake:
    runs-on: ubuntu-latest
    steps:
      - name: Show event payload
        run: |
          echo "$GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

      - name: Extract run_id and objective
        id: extract
        run: |
          set -e
          RUN_ID=$(jq -r '.client_payload.orchestrator.run_id // .client_payload.run_id' "$GITHUB_EVENT_PATH")
          OBJ=$(jq -r '.client_payload.orchestrator.objective // ""' "$GITHUB_EVENT_PATH")
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "No run_id found in payload"
            exit 1
          fi
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "objective=$OBJ" >> $GITHUB_OUTPUT
          echo "Extracted run_id=$RUN_ID"

      - name: Create orchestrator issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runId = '${{ steps.extract.outputs.run_id }}';
            const objective = `${{ steps.extract.outputs.objective }}`;
            const body = [
              `**Run ID:** ${runId}`,
              `**Objective:** ${objective}`,
              '',
              '### Steps',
              '- [ ] Review objective',
              '- [ ] Prepare build plan',
              '- [ ] Comment `/start-build` when ready to begin',
              '',
              '_Generated by Orchestrator_'
            ].join('\n');

            const res = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Orchestrator: Plan for ${runId}`,
              body
            });

            core.info(`Created issue #${res.data.number}`);
