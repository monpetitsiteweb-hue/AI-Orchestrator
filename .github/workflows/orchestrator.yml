      - name: Build Lovable brief (robust)
        id: brief
        env:
          RUN_ID: ${{ steps.extract.outputs.run_id }}
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}
        run: |
          set -eo pipefail

          echo "== Copy judge from payload if present =="
          if jq -e '.client_payload.orchestrator.judge' "$GITHUB_EVENT_PATH" >/dev/null 2>&1; then
            jq '.client_payload.orchestrator.judge' "$GITHUB_EVENT_PATH" > judge.json
            echo "Judge loaded from payload."
          else
            echo "Judge not in payload, fetching from Supabase…"
            URL="${SUPABASE_URL}/rest/v1/orch_messages?run_id=eq.${RUN_ID}&role=eq.judge&select=content_json,id&order=id.desc&limit=1"
            HTTP=$(curl -sS -o supa.json -w "%{http_code}" \
              -H "apikey: ${SUPABASE_ANON_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
              "$URL")
            echo "Supabase HTTP $HTTP"
            cat supa.json || true
            if [ "$HTTP' " -ge 300 ] || ! jq -e '.[0].content_json' supa.json >/dev/null 2>&1; then
              echo "WARN: Could not fetch judge from Supabase; using empty fallback."
              printf '{}' > judge.json
            else
              jq '.[0].content_json' supa.json > judge.json
            fi
          fi

          echo "== judge.json =="
          cat judge.json || true

          # Acceptance may live either in judge or at payload level; we normalize.
          jq -n \
            --slurpfile judge judge.json \
            --slurpfile evt "$GITHUB_EVENT_PATH" \
            '
              def arr(x): if (x|type)=="array" then x else [] end;
              {
                judge: $judge[0],
                acc_hint: (
                  arr($evt[0].client_payload.acceptance)
                  + arr($evt[0].client_payload.orchestrator.acceptance)
                )
              }
            ' > plan.json

          echo "== plan.json (normalized) =="
          jq . plan.json || true

          # Build a resilient Lovable brief; never fail if fields are missing.
          jq -r '
            def bullets($a):
              if ($a|type)=="array" and ($a|length)>0
              then ($a[]|"- "+tostring)
              else "- (none)"
              end;

            . as $root
            | ($root.judge.final_tasks // []) as $fts
            | ($fts[0] // {}) as $t
            | ( ($root.judge.acceptance // []) + ($root.acc_hint // []) ) as $acc

            | (
                "## Lovable Build Brief",
                "",
                "**Goal**",
                ($t.title // "Unnamed task"),
                "",
                "**Why**",
                ($t.why // "—"),
                "",
                "**Steps**",
                bullets($t.steps // []),
                "",
                "**Acceptance (must be testable)**",
                bullets($acc),
                "",
                "_Auto-posted from Orchestrator plan_"
              ) | join("\n")
          ' plan.json > lovable_brief.md

          echo "== lovable_brief.md =="
          cat lovable_brief.md || true
