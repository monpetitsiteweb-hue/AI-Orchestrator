name: Orchestrator Plan Intake

on:
  repository_dispatch:
    types: [orchestrator_plan_ready]

permissions:
  contents: write
  issues: write

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  intake:
    runs-on: ubuntu-latest
    steps:
      - name: Show event payload (debug)
        run: |
          echo "$GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

      - name: Extract run_id & objective (robust)
        id: extract
        run: |
          set -e
          # Try multiple locations for run_id to be future-proof
          RUN_ID=$(
            jq -r '
              .client_payload.run_id
              // .client_payload.orchestrator.run_id
              // empty
            ' "$GITHUB_EVENT_PATH"
          )
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "No run_id found in client_payload"; exit 1
          fi
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

          # Try to extract a human objective; accept various locations
          OBJ=$(
            jq -r '
              .client_payload.objective
              // .client_payload.orchestrator.objective
              // "Orchestrator plan"
            ' "$GITHUB_EVENT_PATH"
          )
          echo "objective=$OBJ" >> "$GITHUB_OUTPUT"

      - name: Create Issue (work order)
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const runId = "${{ steps.extract.outputs.run_id }}";
            const objective = "${{ steps.extract.outputs.objective }}";
            const body = [
              `**Run ID:** ${runId}`,
              `**Objective:** ${objective}`,
              "",
              "### Steps",
              "- (Lovable brief will be posted below automatically)",
              "",
              "### Acceptance",
              "- (Acceptance will be posted below automatically)",
              "",
              "_Generated by Orchestrator_"
            ].join("\n");

            const { data } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Orchestrator: Plan for ${runId}`,
              body
            });

            core.setOutput('issue_number', String(data.number));

    - name: Build Lovable brief (from payload or Supabase)
      shell: bash
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        RUN_ID: ${{ steps.parse.outputs.run_id }}
      run: |
        set -e

        # Try payload first
        jq -e '.client_payload.orchestrator.judge' "$GITHUB_EVENT_PATH" > judge.json || true

        # Fallback to Supabase (your table is orchestrator.messages)
        if [ ! -s judge.json ]; then
          echo "Judge not in payload, fetching from Supabase…"
          URL="${SUPABASE_URL}/rest/v1/orchestrator.messages?run_id=eq.${RUN_ID}&role=eq.judge&select=content_json,id&order=id.desc&limit=1"
          HTTP=$(curl -sS -o supa.json -w "%{http_code}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            "$URL")
          echo "Supabase HTTP $HTTP"
          cat supa.json

          if [ "$HTTP" -ge 300 ]; then
            echo "Failed to fetch judge JSON from Supabase"; exit 1
          fi

          jq -e '.[0].content_json' supa.json > judge.json
        fi

        jq -e '.' judge.json > /dev/null

        # Create plan.json (normalize)
        jq -n \
          --slurpfile judge judge.json \
          --slurpfile evt "$GITHUB_EVENT_PATH" \
          '
            {
              judge: $judge[0],
              payload_acceptance: ($evt[0].client_payload.acceptance // $evt[0].client_payload.orchestrator.acceptance // null)
            }
          ' > plan.json

        # Render brief.md
        jq -r '
          def bullets($arr):
            if ($arr|type) == "array" and ($arr|length) > 0
            then ($arr[] | "- " + (tostring)) else "- (none)" end;

          . as $root
          | ($root.judge.final_tasks[0] // {}) as $t
          | ($root.judge.acceptance // $root.payload_acceptance // []) as $acc
          | (
              "## Lovable Build Brief",
              "",
              "**Goal**",
              ($t.title // "Unnamed task"),
              "",
              "**Why**",
              ($t.why // "—"),
              "",
              "**Steps**",
              (bullets($t.steps)),
              "",
              "**Acceptance (must be testable)**",
              (bullets($acc)),
              "",
              "_Auto-posted from Orchestrator plan_"
            ) | join("\n")
        ' plan.json > lovable_brief.md

        echo "brief_ready=true" >> $GITHUB_OUTPUT

    - name: Post Lovable brief as issue comment
      if: steps.parse.outputs.issue_number && steps.parse.outputs.issue_number != '' && steps.build_lovable.outputs.brief_ready == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const body = fs.readFileSync('lovable_brief.md', 'utf8');
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: Number('${{ steps.parse.outputs.issue_number }}'),
            body
          });


      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: orchestrator-plan-${{ steps.extract.outputs.run_id }}
          path: plan.json
