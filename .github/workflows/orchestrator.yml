name: Orchestrator Plan Intake

on:
  repository_dispatch:
    types: [orchestrator_plan_ready]

permissions:
  contents: write
  issues: write

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  intake:
    runs-on: ubuntu-latest

    steps:
      - name: Show event payload (debug)
        run: |
          echo "$GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

      - name: Extract run_id & objective from payload
        id: extract
        run: |
          RUN_ID=$(jq -r '.client_payload.run_id' "$GITHUB_EVENT_PATH")
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "No run_id in client_payload"; exit 1
          fi
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

          OBJ=$(jq -r '.client_payload.objective // "Orchestrator plan"' "$GITHUB_EVENT_PATH")
          echo "objective=$OBJ" >> "$GITHUB_OUTPUT"

      - name: Create Issue (work order)
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const runId = "${{ steps.extract.outputs.run_id }}";
            const objective = "${{ steps.extract.outputs.objective }}";
            const body = [
              `**Run ID:** ${runId}`,
              `**Objective:** ${objective}`,
              "",
              "### Steps",
              "- (Lovable brief will be posted below automatically)",
              "",
              "### Acceptance",
              "- (Acceptance will be posted below automatically)",
              "",
              "_Generated by Orchestrator_"
            ].join("\n");

            const { data } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Orchestrator: Plan for ${runId}`,
              body
            });

            core.setOutput('issue_number', String(data.number));

      - name: Fetch Judge JSON (final plan) from Supabase
        id: fetch_plan
        env:
          RUN_ID: ${{ steps.extract.outputs.run_id }}
        run: |
          set -e

          # Pull the Judge (final merged plan) message for this run.
          # Using id.desc for ordering (safer than created_at if column absent).
          URL="${SUPABASE_URL}/rest/v1/orch_messages?run_id=eq.${RUN_ID}&role=eq.judge&select=content_json,id&order=id.desc&limit=1"

          HTTP=$(curl -sS -o judge.json -w "%{http_code}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            "$URL")

          echo "HTTP $HTTP"
          cat judge.json

          if [ "$HTTP" -ge 300 ]; then
            echo "Failed to fetch judge JSON"; exit 1
          fi

          # Extract the plan object (content_json of first row)
          jq -e '.[0].content_json' judge.json > plan.json

          # Build a concise Lovable brief from final_tasks[0] + acceptance[]
          jq -r '
            def bullets($arr):
              if ($arr|type) == "array" and ($arr|length) > 0
              then ($arr[] | "- " + (tostring))
              else "- (none)"
              end;

            . as $p
            | ($p.final_tasks[0] // {}) as $t
            | (
                "## Lovable Build Brief",
                "",
                "**Goal**",
                ($t.title // "Unnamed task"),
                "",
                "**Why**",
                ($t.why // "â€”"),
                "",
                "**Steps**",
                (bullets($t.steps)),
                "",
                "**Acceptance (must be testable)**",
                (bullets($p.acceptance)),
                "",
                "_Auto-posted from Orchestrator plan_"
              ) | join("\n")
          ' plan.json > lovable_brief.md

          echo "Lovable brief:"
          echo "----------------"
          cat lovable_brief.md
          echo "----------------"

      - name: Comment Lovable brief on the Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = parseInt("${{ steps.create_issue.outputs.issue_number }}", 10);
            const fs = require('fs');
            const body = fs.readFileSync('lovable_brief.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: orchestrator-plan-${{ steps.extract.outputs.run_id }}
          path: plan.json
