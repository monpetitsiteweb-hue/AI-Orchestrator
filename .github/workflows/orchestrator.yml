name: Orchestrator Plan Intake

on:
  repository_dispatch:
    types: [orchestrator_plan_ready]

# allow creating issues
permissions:
  contents: read
  issues: write

jobs:
  intake:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.extract.outputs.run_id }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show full payload
        env:
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
        run: |
          echo "== RAW CLIENT PAYLOAD =="
          echo "$PAYLOAD" | jq '.'

      - name: Extract orchestrator data
        id: extract
        env:
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
        run: |
          # Save only the orchestrator object
          echo "$PAYLOAD" | jq -r '.orchestrator' > orchestrator.json
          echo "Saved orchestrator.json:"
          cat orchestrator.json

          RUN_ID=$(jq -r '.run_id' orchestrator.json)
          OBJECTIVE=$(jq -r '.objective' orchestrator.json)
          STATUS=$(jq -r '.status' orchestrator.json)

          echo "run_id=$RUN_ID"      >> $GITHUB_OUTPUT
          echo "objective=$OBJECTIVE" >> $GITHUB_OUTPUT
          echo "status=$STATUS"       >> $GITHUB_OUTPUT

      - name: Pretty-print tasks
        run: |
          echo "== FINAL TASKS =="
          jq -r '.tasks[] | "- " + .title + "\n  steps:\n" + ( .steps[] | "    - " + . )' orchestrator.json || true

      - name: Save plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: orchestrator-plan-${{ steps.extract.outputs.run_id }}
          path: orchestrator.json

      - name: Create summary
        run: |
          {
            echo "## Orchestrator Plan"
            echo ""
            echo "**Run ID:** ${{ steps.extract.outputs.run_id }}"
            echo "**Objective:** ${{ steps.extract.outputs.objective }}"
            echo "**Status:** ${{ steps.extract.outputs.status }}"
            echo ""
            echo "### Tasks"
            jq -r '.tasks[] | "- **\(.title)**\n  \(.steps | map("- " + .) | join("\n  "))\n"' orchestrator.json || true
            echo ""
            echo "### Acceptance"
            jq -r '.acceptance | if length>0 then ( . | map("- " + .) | join("\n") ) else "_(none)_" end' orchestrator.json || true
            echo ""
            echo "### Blocking"
            jq -r '.blocking | if length>0 then ( . | map("- " + .) | join("\n") ) else "_(none)_" end' orchestrator.json || true
          } >> $GITHUB_STEP_SUMMARY

  create_issues:
    runs-on: ubuntu-latest
    needs: intake
    steps:
      - uses: actions/checkout@v4

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: orchestrator-plan-${{ needs.intake.outputs.run_id }}
          path: .

      - name: Create labels (idempotent)
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              { name: 'orchestrator', color: '1f77b4', description: 'Created by Orchestrator' },
              { name: 'approved-plan', color: '2ca02c', description: 'Approved by Judge' }
            ];
            for (const l of labels) {
              try {
                await github.request('POST /repos/{owner}/{repo}/labels', {
                  owner: context.repo.owner, repo: context.repo.repo,
                  name: l.name, color: l.color, description: l.description
                });
              } catch (e) {
                // ignore if exists
              }
            }

      - name: Open/ensure one issue per task
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = JSON.parse(fs.readFileSync('orchestrator.json','utf8'));
            const labels = ['orchestrator','approved-plan'];

            for (const t of (plan.tasks || [])) {
              const title = `Orchestrator: ${t.title}`;
              // check if an open issue with this exact title already exists
              const search = await github.rest.search.issuesAndPullRequests({
                q: `repo:${context.repo.owner}/${context.repo.repo} in:title "${title}" is:issue is:open`
              });
              if (search.data.items.length > 0) continue; // already exists

              const body = [
                `**Run ID:** ${plan.run_id}`,
                `**Objective:** ${plan.objective}`,
                '',
                '### Steps',
                ...(t.steps || []).map(s => `- [ ] ${s}`),
                '',
                '### Acceptance',
                ...(plan.acceptance || []).map(a => `- ${a}`),
                '',
                '_Generated by Orchestrator_'
              ].join('\n');

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title, body, labels
              });
            }
