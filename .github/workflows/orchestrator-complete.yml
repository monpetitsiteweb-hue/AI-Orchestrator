name: Orchestrator Complete Trigger

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  ORCH_MARK_URL: ${{ secrets.ORCH_MARK_URL }}
  ORCH_ADMIN_SECRET: ${{ secrets.ORCH_ADMIN_SECRET }}

jobs:
  complete:
    if: startsWith(github.event.comment.body, '/complete-build')
    runs-on: ubuntu-latest
    steps:
      - name: Debug comment body
        env:
          BODY: ${{ github.event.issue.body }}
        run: |
          echo "=== RAW COMMENT BODY START ==="
          printf "%s\n" "$BODY"
          echo "=== RAW COMMENT BODY END ==="

      - name: Extract run_id from issue body
        id: extract
        env:
          BODY: ${{ github.event.issue.body }}
        run: |
          set -euo pipefail
          CLEAN="$(printf '%s\n' "$BODY" | tr -d '\r' | sed 's/\*\*//g')"
          RUN_ID="$(printf '%s\n' "$CLEAN" \
            | grep -oE 'Run ID:[[:space:]]*[0-9a-fA-F-]{36}' \
            | head -n1 \
            | sed -E 's/.*Run ID:[[:space:]]*//')"
          if [ -z "$RUN_ID" ]; then
            echo "No Run ID found in issue body"; exit 1
          fi
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Fetch tests from Supabase
        id: fetch_tests
        env:
          RUN_ID: ${{ steps.extract.outputs.run_id }}
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ env.SUPABASE_SERVICE_ROLE }}
        run: |
          set -euo pipefail
          RESP="$(curl -sS "${SUPABASE_URL}/rest/v1/orch_tests?run_id=eq.${RUN_ID}&select=test_name,success,log,created_at" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE}" \
            -H "Accept: application/json")"
          echo "raw_tests=$RESP" >> "$GITHUB_OUTPUT"

          COUNT="$(printf '%s\n' "$RESP" | jq 'length')"
          PASSED="$(printf '%s\n' "$RESP" | jq '[ .[].success ] | all')"

          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "all_passed=$PASSED" >> "$GITHUB_OUTPUT"

          # Build a one-line summary list
          SUMMARY="$(printf '%s\n' "$RESP" \
            | jq -r '[ .[] | "\(.test_name): " + (if .success then "OK" else "FAIL" end) ] | join(", ")')"
          echo "summary=$SUMMARY" >> "$GITHUB_OUTPUT"

      - name: Decide outcome
        id: decide
        run: |
          set -euo pipefail
          COUNT="${{ steps.fetch_tests.outputs.count }}"
          ALL="${{ steps.fetch_tests.outputs.all_passed }}"
          if [ "$COUNT" = "0" ]; then
            echo "verdict=none" >> "$GITHUB_OUTPUT"
            echo "status_msg=âš ï¸ No tests recorded for this run yet." >> "$GITHUB_OUTPUT"
          elif [ "$ALL" = "true" ]; then
            echo "verdict=pass" >> "$GITHUB_OUTPUT"
            echo "status_msg=âœ… All tests passed." >> "$GITHUB_OUTPUT"
          else
            echo "verdict=fail" >> "$GITHUB_OUTPUT"
            echo "status_msg=âŒ Some tests failed." >> "$GITHUB_OUTPUT"
          fi

      - name: Comment summary back to the issue
        uses: actions/github-script@v7
        env:
          RUN_ID: ${{ steps.extract.outputs.run_id }}
          COUNT: ${{ steps.fetch_tests.outputs.count }}
          SUMMARY: ${{ steps.fetch_tests.outputs.summary }}
          STATUS_MSG: ${{ steps.decide.outputs.status_msg }}
        with:
          script: |
            const runId   = process.env.RUN_ID;
            const count   = process.env.COUNT;
            const summary = process.env.SUMMARY || 'â€”';
            const msg     = process.env.STATUS_MSG;

            const body = [
              `ðŸ§ª Test summary for run ${runId}`,
              ``,
              count === '0'
                ? `No tests recorded for this run yet.`
                : `Tests: ${summary}`,
              ``,
              `Status: ${msg}`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Mark run status in Supabase
        if: ${{ steps.decide.outputs.verdict != 'none' }}
        env:
          RUN_ID: ${{ steps.extract.outputs.run_id }}
          VERDICT: ${{ steps.decide.outputs.verdict }}
          ORCH_MARK_URL: ${{ env.ORCH_MARK_URL }}
          ORCH_ADMIN_SECRET: ${{ env.ORCH_ADMIN_SECRET }}
        run: |
          set -euo pipefail
          if [ "$VERDICT" = "pass" ]; then
            STATUS="built"
          else
            STATUS="needs_revision"
          fi
          curl -sS -X POST "$ORCH_MARK_URL" \
            -H "x-orch-admin: $ORCH_ADMIN_SECRET" \
            -H "content-type: application/json" \
            -d "{\"run_id\":\"${RUN_ID}\",\"status\":\"${STATUS}\"}"

