name: Orchestrator Test Runner

on:
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  issues: write

env:
  EXEC_BASE_URL: ${{ secrets.EXEC_BASE_URL }}                 # https://<your-project>.supabase.co/functions/v1
  ORCH_TEST_URL: ${{ secrets.ORCH_TEST_URL }}                 # Supabase edge: orchestrator-test-result
  ORCH_ADMIN_SECRET: ${{ secrets.ORCH_ADMIN_SECRET }}         # shared secret
  AUTO_REVISE: ${{ secrets.AUTO_REVISE }}                     # "true" to auto-revise on failures
  REVIEW_URL: ${{ secrets.ORCH_REVIEW_URL }}                  # Supabase edge: orchestrator-review
  ALLOW_WRAP: ${{ secrets.ALLOW_WRAP }}                       # "true" to run execute test

jobs:
  run_tests:
    if: startsWith((github.event.comment.body || '') , '/test')
    runs-on: ubuntu-latest
    steps:
      - name: Debug comment body
        run: |
          echo "=== RAW COMMENT BODY ==="
          printf "%s\n" "${{ github.event.comment.body }}"
          echo "========================"
            
      - name: Extract run_id (robust)
        id: extract
        env:
          BODY: ${{ github.event.issue.body }}
        run: |
          set -euo pipefail
          # Try bold and plain "Run ID:" patterns
          RUN_ID=$(
            printf "%s\n" "$BODY" | sed -n 's/.*\*\*Run ID:\*\*\s*\([0-9a-f-]\{36\}\).*/\1/p' | head -n1
          )
          if [ -z "$RUN_ID" ]; then
            RUN_ID=$(
              printf "%s\n" "$BODY" | sed -n 's/.*Run ID:\s*\([0-9a-f-]\{36\}\).*/\1/p' | head -n1
            )
          fi
          if [ -z "$RUN_ID" ]; then
            echo "No Run ID found in issue body"; exit 1
          fi
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Quick sanity (prompt exists?)
        id: prompt_check
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
          RUN_ID: ${{ steps.extract.outputs.run_id }}
        run: |
          set -euo pipefail
          RESP="$(curl -sS "${SUPABASE_URL}/rest/v1/runs?id=eq.${RUN_ID}&select=final_prompt_markdown" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE}")"
          LEN="$(echo "$RESP" | jq -r '.[0].final_prompt_markdown | if type=="string" then length else 0 end')"
          OK=false
          if [ "$LEN" -gt 0 ]; then OK=true; fi
          echo "present=$OK" >> "$GITHUB_OUTPUT"
          echo "len=$LEN" >> "$GITHUB_OUTPUT"

      - name: Post prompt presence summary
        uses: actions/github-script@v7
        with:
          script: |
            const present = "${{ steps.prompt_check.outputs.present }}" === "true";
            const len = Number("${{ steps.prompt_check.outputs.len }}");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚Ä¢ Prompt present: ${present ? "true ‚Äî ‚úÖ" : "false ‚Äî ‚ùå"}\n‚Ü≥ final_prompt_markdown ${present ? `present (len=${len})` : "missing"}`
            });

      - name: Plan-only test ‚Äî /wallet-ensure-weth
        id: plan_only
        env:
          EXEC_BASE_URL: ${{ env.EXEC_BASE_URL }}
        run: |
          set -euo pipefail
          if [ -z "${EXEC_BASE_URL}" ]; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "msg=Missing EXEC_BASE_URL; skipping endpoint test" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Use a tiny minWeth to likely hit action=none (safe). If your balance is 0 WETH, it will return action=wrap (also OK).
          PAY='{"address":"0x2C779B78175d4069CcF2C8d79268957F5a06CF68","minWethNeededWei":"1000000000000","autoWrap":false}'
          HTTP=$(curl -sS -o resp.json -w "%{http_code}" -X POST "${EXEC_BASE_URL}/wallet-ensure-weth" \
            -H "content-type: application/json" \
            -d "$PAY")
          if [ "$HTTP" != "200" ]; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "msg=HTTP ${HTTP} calling /wallet-ensure-weth (autoWrap=false)" >> "$GITHUB_OUTPUT"
            cat resp.json || true
            exit 0
          fi
          ACT=$(jq -r '.action // empty' resp.json)
          if [ -z "$ACT" ]; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "msg=missing action in response" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "msg=Plan-only OK (action=${ACT})" >> "$GITHUB_OUTPUT"

      - name: Execute test ‚Äî /wallet-ensure-weth (autoWrap=true)
        id: execute
        env:
          EXEC_BASE_URL: ${{ env.EXEC_BASE_URL }}
          ALLOW_WRAP: ${{ env.ALLOW_WRAP }}
        run: |
          set -euo pipefail
          if [ "${ALLOW_WRAP}" != "true" ]; then
            echo "ok=skip" >> "$GITHUB_OUTPUT"
            echo "msg=Execute test skipped (ALLOW_WRAP!=true)" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ -z "${EXEC_BASE_URL}" ]; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "msg=Missing EXEC_BASE_URL; skipping execute" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Ask for a tiny top-up; server will compute deficit and enforce ETH buffer
          PAY='{"address":"0x2C779B78175d4069CcF2C8d79268957F5a06CF68","minWethNeededWei":"200000000000000","autoWrap":true,"maxWaitMs":12000}'
          HTTP=$(curl -sS -o resp2.json -w "%{http_code}" -X POST "${EXEC_BASE_URL}/wallet-ensure-weth" \
            -H "content-type: application/json" -d "$PAY")
          if [ "$HTTP" != "200" ]; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            MSG=$(cat resp2.json 2>/dev/null || echo "")
            echo "msg=HTTP ${HTTP} execute result ${MSG}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          OK=$(jq -r '.ok // false' resp2.json)
          ACT=$(jq -r '.action // empty' resp2.json)
          TX=$(jq -r '.txHash // empty' resp2.json)
          if [ "$OK" = "true" ] && [ "$ACT" = "wrap" ] && [ -n "$TX" ]; then
            echo "ok=true" >> "$GITHUB_OUTPUT"
            echo "msg=Execute OK (txHash=${TX})" >> "$GITHUB_OUTPUT"
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "msg=Unexpected execute response: $(cat resp2.json)" >> "$GITHUB_OUTPUT"
          fi

      - name: Report each result to Supabase
        env:
          RUN_ID: ${{ steps.extract.outputs.run_id }}
          TEST_API: ${{ env.ORCH_TEST_URL }}
          ORCH_ADMIN_SECRET: ${{ env.ORCH_ADMIN_SECRET }}
        run: |
          set -euo pipefail
          # Prompt presence is informational ‚Äî don't persist as pass/fail
          # Plan-only:
          curl -sS -X POST "$TEST_API" -H "x-orch-admin: ${ORCH_ADMIN_SECRET}" -H "content-type: application/json" \
            -d "{\"run_id\":\"${RUN_ID}\",\"test_name\":\"plan_only_wallet_ensure_weth\",\"success\":${{ steps.plan_only.outputs.ok == 'true' }},\"log\":\"${{ steps.plan_only.outputs.msg }}\"}"
          # Execute:
          if [ "${{ steps.execute.outputs.ok }}" = "skip" ]; then
            echo "Execute test was skipped."
          else
            curl -sS -X POST "$TEST_API" -H "x-orch-admin: ${ORCH_ADMIN_SECRET}" -H "content-type: application/json" \
              -d "{\"run_id\":\"${RUN_ID}\",\"test_name\":\"execute_wallet_ensure_weth\",\"success\":${{ steps.execute.outputs.ok == 'true' }},\"log\":\"${{ steps.execute.outputs.msg }}\"}"
          fi

      - name: Summarize in Issue
        uses: actions/github-script@v7
        env:
          RUN_ID: ${{ steps.extract.outputs.run_id }}
        with:
          script: |
            const lines = [];
            lines.push(`üß™ Test summary for run ${process.env.RUN_ID}`);
            const prompt = "present (already shown above)";
            lines.push(`‚Ä¢ Prompt present: true ‚Äî ‚úÖ`);
            lines.push(`‚Ä¢ Plan-only /wallet-ensure-weth: ${{ steps.plan_only.outputs.ok || 'false' }} ‚Äî ${{ steps.plan_only.outputs.ok == 'true' ? '‚úÖ' : '‚ùå' }}`);
            lines.push(`‚Ü≥ ${{ steps.plan_only.outputs.msg || '' }}`);
            if ("${{ steps.execute.outputs.ok }}" === "skip") {
              lines.push(`‚Ä¢ Execute /wallet-ensure-weth: skipped (set secret ALLOW_WRAP=true to enable)`);
            } else {
              lines.push(`‚Ä¢ Execute /wallet-ensure-weth: ${{ steps.execute.outputs.ok || 'false' }} ‚Äî ${{ steps.execute.outputs.ok == 'true' ? '‚úÖ' : '‚ùå' }}`);
              lines.push(`‚Ü≥ ${{ steps.execute.outputs.msg || '' }}`);
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: lines.join("\n")
            });

      - name: Auto-revise if any failure (calls orchestrator-review)
        if: env.AUTO_REVISE == 'true'
        env:
          ANY_FAIL: ${{ steps.plan_only.outputs.ok != 'true' || (steps.execute.outputs.ok != 'skip' && steps.execute.outputs.ok != 'true') }}
          REVIEW_URL: ${{ env.REVIEW_URL }}
          ORCH_ADMIN_SECRET: ${{ env.ORCH_ADMIN_SECRET }}
          RUN_ID: ${{ steps.extract.outputs.run_id }}
        run: |
          set -euo pipefail
          if [ "${ANY_FAIL}" != "true" ]; then
            echo "All tests green or execute skipped ‚Äî no auto-revision."; exit 0
          fi
          if [ -z "${REVIEW_URL}" ]; then
            echo "No REVIEW_URL secret set; cannot auto-revise."; exit 0
          fi
          echo "Triggering orchestrator-review for run ${RUN_ID}‚Ä¶"
          curl -sS -X POST "${REVIEW_URL}" \
            -H "x-orch-admin: ${ORCH_ADMIN_SECRET}" \
            -H "content-type: application/json" \
            -d "{\"run_id\":\"${RUN_ID}\"}"
