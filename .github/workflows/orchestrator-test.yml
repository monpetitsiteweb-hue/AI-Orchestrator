name: Orchestrator Test Runner

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  run_tests:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      EXEC_BASE_URL: ${{ secrets.EXEC_BASE_URL }}
      BOT_ADDRESS: ${{ secrets.BOT_ADDRESS }}
      ALLOW_WRAP: ${{ secrets.ALLOW_WRAP }}          # "true" to run submit path
      RPC_URL_8453: ${{ secrets.RPC_URL_8453 }}      # ensure this is QuickNode

    steps:
      - name: Extract run_id from issue body
        id: extract
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID=$(printf "%s\n" "$BODY" | sed -nE 's/.*[Rr]un[[:space:]]*ID[:*]*[[:space:]]*([0-9a-fA-F-]{36}).*/\1/p' | head -n1)
          if [ -z "$RUN_ID" ]; then echo "No Run ID found in issue body"; exit 1; fi
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
        env:
          BODY: ${{ github.event.issue.body }}

      - name: Check final_prompt_markdown present
        id: prompt
        shell: bash
        run: |
          set -euo pipefail
          RESP="$(curl -sS "${SUPABASE_URL}/rest/v1/runs?id=eq.${{ steps.extract.outputs.run_id }}&select=final_prompt_markdown" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "Accept: application/json")"
          LEN=$(echo "$RESP" | jq -r '.[0].final_prompt_markdown | length // 0')
          if [ "$LEN" -gt 0 ]; then
            echo "ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
          fi
          echo "len=$LEN" >> "$GITHUB_OUTPUT"

      - name: Call /wallet-ensure-weth (plan-only)
        id: plan
        shell: bash
        run: |
          set -euo pipefail
          # Always send Authorization to Edge Functions
          RESP="$(curl -sS -X POST "${EXEC_BASE_URL}/wallet-ensure-weth" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "Content-Type: application/json" \
            --data '{"action":"plan","owner":"'"${BOT_ADDRESS}"'","amountWei":"100000000000000"}' || true)"
          OK=$(echo "$RESP" | jq -r '.ok // false')
          MSG=$(echo "$RESP" | jq -r '.message // ""')
          # Write multi-line safe output
          echo "ok=$OK" >> "$GITHUB_OUTPUT"
          {
            echo 'msg<<EOF'
            echo "$MSG"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: (Optional) Execute wrap submit when allowed
        id: exec
        if: env.ALLOW_WRAP == 'true'
        shell: bash
        run: |
          set -euo pipefail
          RESP="$(curl -sS -X POST "${EXEC_BASE_URL}/wallet-ensure-weth" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "Content-Type: application/json" \
            --data '{"action":"submit","owner":"'"${BOT_ADDRESS}"'","amountWei":"100000000000000"}' || true)"
          OK=$(echo "$RESP" | jq -r '.ok // false')
          CODE=$(echo "$RESP" | jq -r '.code // ""')
          TX=$(echo "$RESP" | jq -r '.txHash // ""')
          MSG=$(echo "$RESP" | jq -r '.message // ""')
          echo "ok=$OK" >> "$GITHUB_OUTPUT"
          echo "code=$CODE" >> "$GITHUB_OUTPUT"
          echo "tx=$TX" >> "$GITHUB_OUTPUT"
          {
            echo 'msg<<EOF'
            echo "$MSG"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Post test summary
        uses: actions/github-script@v7
        with:
          script: |
            const runId   = "${{ steps.extract.outputs.run_id }}";
            const promptOk = "${{ steps.prompt.outputs.ok }}" === "true";
            const promptLen= "${{ steps.prompt.outputs.len }}";

            const planOk   = "${{ steps.plan.outputs.ok }}" === "true";
            const planMsg  = String.raw`${{ steps.plan.outputs.msg }}`;   // safe, not inline JSON

            const execRan  = process.env.ALLOW_WRAP === "true";
            const execOk   = execRan ? ("${{ steps.exec.outputs.ok }}" === "true") : false;
            const execTx   = execRan ? "${{ steps.exec.outputs.tx }}" : "";
            const execCode = execRan ? "${{ steps.exec.outputs.code }}" : "";
            const execMsg  = execRan ? String.raw`${{ steps.exec.outputs.msg }}` : "Set secret ALLOW_WRAP=true to enable on-chain wrap test";

            const lines = [];
            lines.push(`üß™ Test summary for run ${runId}`);
            lines.push("");
            lines.push(`‚Ä¢ Prompt present: ${promptOk ? "‚úÖ" : "‚ùå"}`);
            lines.push(`‚Ü≥ final_prompt_markdown present (len=${promptLen})`);
            lines.push(`‚Ä¢ Plan-only /wallet-ensure-weth: ${planOk ? "‚úÖ" : "‚ùå"}`);
            lines.push(`‚Ü≥ ${planOk ? "Plan-only OK" : planMsg}`);
            lines.push(`‚Ä¢ Execute /wallet-ensure-weth: ${execRan ? (execOk ? "‚úÖ" : "‚ùå") : "‚è≠Ô∏è"}`);
            lines.push(`‚Ü≥ ${execRan ? (execOk ? `Wrap tx: ${execTx}` : `code=${execCode} msg=${execMsg}`) : execMsg}`);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: lines.join("\n")
            });
        env:
          ALLOW_WRAP: ${{ env.ALLOW_WRAP }}
